'use strict';

var assert     = require('chai').assert;
var mockery    = require('mockery');
var sinon      = require('sinon'); // TODO change mocks to use sinon

var mockObject = require('AGL/mock/mockObject');

describe('builder', function () {

	// Module

	var builder = null;

	// Mocks

	var validationMock = null;
	var validateMock = null

	// Setup

	before(function () {
		mockery.enable({ useCleanCache: true });
	});

	beforeEach(function () {
		validationMock = mockObject.NewMockObject();
		validationMock.Mock('Validate', undefined);

		mockery.registerMock('AGL/validation', validationMock);

		mockery.registerAllowable('validate.js'); // TODO need sinon to mock this

		mockery.registerAllowable('AGL/builder');
		builder = require('AGL/builder');
	});

	// Teardown

	afterEach(function () {
		mockery.deregisterAll();
		validationMock = null;
		validateMock = null;
		builder = null;
	});

	after(function () {
		mockery.disable();
	});

	// Tests

	describe('NewBuilder()', function () {

		it('should return an object when passed valid arguments', function () {
			var propertyMap = {
				prop1 : {
					required : true,
					type     : 'string' 
				}
			};
			assert.isObject(
				builder.NewBuilder(propertyMap, 'testObject'),
				'expected to return an object'
			)
		});

		it('should throw an error when objectName argument is missing', function () {
			var propertyMap = {
				prop1 : {
					required : true,
					type     : 'string' 
				}
			};
			assert.throw(
				function () {
					builder.NewBuilder(propertyMap);
				},
				/'objectName' argument required to create a new Builder./,
				'expected to throw an error'
			);
		});

		it('should throw an error when propertyMap argument is missing', function () {
			assert.throw(
				function () {
					builder.NewBuilder();
				},
				/'propertyMap' argument required to create a new Builder./,
				'expected to return an error'
			);
		});

		describe('Property Map validation', function () {

			it('should throw an error when property is missing \'required\' flag', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						type     : 'string'
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must have a 'required' property set to either true or false./,
					'expected to throw an error'
				);
			});

			it('should throw an error when \'required\' flag is not a boolean value', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required : 'yes',
						type     : 'string'
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must have a 'required' property set to either true or false./,
					'expected to throw an error'
				);
			});

			it('should throw an error when propery is missing \'type\' property', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required : true,
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must have a 'type' property./,
					'expected to throw an error'
				);
			});

			it('should throw an error when \'required\' flag is false and there are no'
				+ ' \'default_value\' or \'database_default\' properties', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required : false,
						type     : 'string'
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must have either a 'default_value' or a 'database_default' property/,
					'expected to throw an error'
				);
			});

			it('should throw an error when a property has both a \'default_value\' and'
					+ ' a \'database_default\'', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : false,
						type             : 'string',
						default_value    : 'property2',
						database_default : true
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, should not have both 'default_value' and 'database_default' properties./,
					'expected to throw an error'
				);
			});

			it('should throw an error if a \'database_default\' is included but'
					+ ' not set to true', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : false,
						type             : 'string',
						database_default : false
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must have the 'database_default' property set to true/,
					'expected to throw an error'
				);
			});

			it('should throw an error when a property has either a \'default_value\''
					+ ' or a \'database_default\' property when \'required\' is'
					+ ' set to true', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required      : true,
						type          : 'string',
						default_value : 'property2'
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must not have a 'default_value' or a 'database_default' property/,
					'expected to throw an error'
				);

				propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : true,
						type             : 'string',
						database_default : true
					}
				};
				assert.throw(
					function () {
						builder.NewBuilder(propertyMap, 'testObject');
					},
					/prop2 in the testObject property map, must not have a 'default_value' or a 'database_default' property/,
					'expected to throw an error'
				);
			});

		});

	});

	describe('Builder Object', function () {

		it('should have a setter for each of its properties', function () {
			var propertyMap = {
				prop1 : {
					required : true,
					type     : 'none'
				},
				prop2 : {
					required         : false,
					type             : 'string',
					default_value    : 'property2'
				},
				prop3 : {
					required         : false,
					type             : 'string',
					database_default : true
				}
			};
			var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
			assert.isFunction(
				testObjectBuilder.SetProp1,
				'expected \'SetProp1\' to be a function in testObjectBuilder'
			);
			assert.isFunction(
				testObjectBuilder.SetProp2,
				'expected \'SetProp2\' to be a function in testObjectBuilder'
			);
			assert.isFunction(
				testObjectBuilder.SetProp3,
				'expected \'SetProp3\' to be a function in testObjectBuilder'
			);
		});

		it('should throw an error if Build() is called before OnValidationErrors()', function () {
			var propertyMap = {
				prop1 : {
					required : true,
					type     : 'none'
				}
			};
			var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
			assert.throw(
				function () {
					testObjectBuilder.SetProp1('property1').Build();
				},
				/Unhandled errors. Call OnValidationErrors\(handler\) before calling Build\(\)/,
				'expected to throw an error'
			);
		});

		it('should throw an error if OnValidationErrors() is not passed a function', function () {
			var propertyMap = {
				prop1 : {
					required : true,
					type     : 'none'
				}
			};
			var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
			assert.throw(
				function () {
					testObjectBuilder.SetProp1('property1').OnValidationErrors('error!').Build();
				},
				/OnValidationErrors\(\). handler argument must be a function./,
				'expected to throw an error'
			);
		});

		it('should return an Object when Build() is called', function () {
			var propertyMap = {
				prop1 : {
					required : true,
					type     : 'none'
				},
				prop2 : {
					required : true,
					type     : 'none'
				}
			};
			var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
			assert.isObject(
				testObjectBuilder
				.SetProp1('property1')
				.SetProp2('property2')
				.OnValidationErrors(function () {})
				.Build(),
				'expected to return an Object'
			);
		});

		describe('ImmutableObject', function () {

			it('should have a getter for each of its properties', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : false,
						type             : 'string',
						default_value    : 'property2'
					},
					prop3 : {
						required         : false,
						type             : 'string',
						database_default : true
					}
				};
				var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
				var testObject = testObjectBuilder
					.SetProp1('property1')
					.SetProp2('property2')
					.SetProp3('property3')
					.OnValidationErrors(function () {})
					.Build();
				assert.isFunction(
					testObject.GetProp1,
					'expected \'GetProp1\' to be a function in testObject'
				);
				assert.isFunction(
					testObject.GetProp2,
					'expected \'GetProp2\' to be a function in testObject'
				);
				assert.isFunction(
					testObject.GetProp3,
					'expected \'GetProp3\' to be a function in testObject'
				);
			});

			it('should return the correct property for each getter', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : false,
						type             : 'string',
						default_value    : 'property2'
					},
					prop3 : {
						required         : false,
						type             : 'string',
						database_default : true
					}
				};
				var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
				var testObject = testObjectBuilder
					.SetProp1('property1')
					.SetProp2('property2!')
					.SetProp3('property3!')
					.OnValidationErrors(function () {})
					.Build();
				assert.strictEqual(
					testObject.GetProp1(),
					'property1',
					'expected \'GetProp1()\' to return \'property1\''
				);
				assert.strictEqual(
					testObject.GetProp2(),
					'property2!',
					'expected \'GetProp2()\' to return \'property2!\''
				);
				assert.strictEqual(
					testObject.GetProp3(),
					'property3!',
					'expected \'GetProp3()\' to return \'property3!\''
				);
			});

			it('should return a default value for properties with a default'
					+ ' that were not set', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : false,
						type             : 'string',
						default_value    : 'property2'
					},
					prop3 : {
						required         : false,
						type             : 'string',
						database_default : true
					}
				};
				var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
				var testObject = testObjectBuilder
					.SetProp1('property1')
					.SetProp3('property3!')
					.OnValidationErrors(function () {})
					.Build();
					assert.strictEqual(
						testObject.GetProp2(),
						'property2',
						'expected \'GetProp2()\' to return \'property2\''
					);
			});

			it('should return undefined for properties with a database'
					+ ' default that were not set', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required         : false,
						type             : 'string',
						default_value    : 'property2'
					},
					prop3 : {
						required         : false,
						type             : 'string',
						database_default : true
					}
				};
				var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');
				var testObject = testObjectBuilder
					.SetProp1('property1')
					.OnValidationErrors(function () {})
					.Build();
					assert.strictEqual(
						testObject.GetProp3(),
						undefined,
						'expected \'GetProp3()\' to return undefined'
					);
			});

		});

		it('should call validation error handler with an array of errors when validation fails', function () {
				var propertyMap = {
					prop1 : {
						required : true,
						type     : 'none'
					},
					prop2 : {
						required : true,
						type     : 'none'
					}
				};
				var testObjectBuilder = builder.NewBuilder(propertyMap, 'testObject');

				// Mock Validate function to always return an error
				var validationError = new TypeError('validation fail!');
				validationMock.ChangeReturnValue('Validate', validationError);

				var handlerCalled = false;
				var validationErrors = [];
				var testObject = testObjectBuilder
					.SetProp1('invalid value')
					.SetProp2('invalid value')
					.OnValidationErrors( function (errors) {
						handlerCalled = true;
						validationErrors = errors;
					})
					.Build();
				assert.ok(
					handlerCalled,
					'expected builder to call validation error handler'
				);
				assert.isArray(
					validationErrors,
					'expected validation handler to be passed an array of errors'
				);
				assert.strictEqual(
					validationErrors[0],
					validationError,
					'expected two Type Errors in validation errors array'
				);
				assert.strictEqual(
					validationErrors[1],
					validationError,
					'expected two Type Errors in validation errors array'
				);
		});

		it('should pass the validation error handler an array of errors'
				+ ' when validation fails', function () {
		});

		it('should throw an error if Build() is called and required'
				+ ' properties have not been set', function () {
		});

		it('should set relevant properties to their defaults if they were unset', function () {
		});

		it('should set properties with database defaults to'
				+ ' undefined if they were unset', function () {
		});

		it('should reset after building an object', function () {
		});

	});

});
